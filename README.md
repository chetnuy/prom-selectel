### Тестовый проект в облаке Selectel

##### Задача
Показать умение создавать сложные системы по неполному ТЗ, используя простые
базовые элементы.
Необходимо поднять пул виртуальных машин с prometheus-экспортерами и обеспечить
возможность быстрого скейлинга по числу нод и обновления конфигураций
виртуальных машин в облаке Selectel


##### Схема проекта

![image sheme](/doc/scheme.png)


##### Возможности
- Общая настройка проекта, сети, шаблонов и доступа
- Создание/удаление/добавление/скейлинг вм (через переменную count или terraform target)
- Инициализация и базовая настройка вм
- Генерация/перегенерация tls-сертификатов мониторинга, корневой сертификат и ключ хранятся на сервере мониторинга
- Установка/конфигурирование/обновление prometheus сервера
- Установка/конфигурирование/обновление node-exporter на нодах
- Установка/конфигурирование/обновление docker на нодах
- Добавление/удаление ноды в service discovery на базe sd_file

&nbsp;

##### Cистемные требования
- os linux x86_64 (тестировалось на ubuntu 2004, centos7, archlinux upstream)
- terraform v1.1.4 
- python3.8

По необходимости устанавливаем ansible c зависимостями
```bash
sudo apt install python3-testresources
sudo pip3 install --upgrade pip
sudo pip3 install -r requirements.txt
```
&nbsp;


##### Последовательность при разворачивании
Внести данные в vars.tf и запустить **./build.sh**  

Или выполнить пошагам:  

- Внести переменные для доступа к проекту в облаке Selectel и провайдеру openstack в файл vars.tf
- Проинциализировать терраформ провайдер:
```bash
terraform init
```
- Развернуть инфраструктуру:
```bash
terraform apply -auto-approve
```
- Сгенерировать файл inventory:
```bash
export TF_STATE=. && ./terraform-inventory -inventory > inventory.ini
```
- По необходимости настроить переменные для работы ansible в group_vars/all.yaml
- Запустить разворачивание и настройку служб проекта:
```bash
ansible-playbook -i inventory.ini playbooks/all.yaml

```
- Для доступа к web-интерфейсу prometheus берем вывод из консоли установки, или самостоятельно берем ip из файла inventory. Пароль и пользователь прописаны в vars.yml

- Для подключения к узлам используем jump_host, пример
```bash
ssh -o ProxyCommand="ssh -i ./ssh-key/id_rsa -W %h:%p root@146.146.52.52" -i ./ssh-key/id_rsa root@10.10.0.20
```
&nbsp;

##### Примечание 
В директории playbooks содержатся готовые манифесты для выполнения различных фаз работы с системой. Не обязательно запускать весь процесс установки если необходимо обновить пакет, заменить сертификат или добавить узел.  
*Возможные улучшения* которые потребовали бы время, а также усложнили проект: настройка consul или интеграция prometheus c проектом openstack для sd.  
В процессе работы провайдер selectel создавал проекты которые не отображались в течении часа в панели, а также он не имеет datasource. Поэтому не был использован.  
